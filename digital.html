<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>TikTok-Simulator Modern ‚Äì bessere Ad-Personalisierung</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Montserrat', Arial, sans-serif;
      background: #000;
    }

    .app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    .image-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-width: 0;
    }

    .post-frame{
      width: 80%;
      max-width: 400px;
      aspect-ratio: 3/4;
      border-radius: 20px;
      overflow: hidden;

      background: #0f0f0f;
      border: 2px solid rgba(255,255,255,0.18);
      box-shadow: 0 12px 40px rgba(0,0,0,0.55);

      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .post-frame.portrait img,
    .post-frame.portrait iframe{
      width: 100%;
      height: 100%;
    }

    .post-frame.portrait img{
      object-fit: cover;
    }

    .post-frame.landscape{
      background: #2a2a2a;
    }

    .post-frame.landscape img{
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .post-frame.landscape iframe{
      width: 100%;
      height: 100%;
      transform: scale(0.92);
      border-radius: 12px;
    }

    #postMedia{
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .post-frame img,
    .post-frame iframe{
      border: 0;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .icons {
      position: absolute;
      right: calc(50% - 320px);
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 10;
    }

    .icon-btn {
      background: rgba(255,255,255,0.7);
      border: none;
      color: black;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: 0.3s;
    }

    .icon-btn:hover {
      background: white;
      color: red;
    }

    .icon-btn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    .ai-section {
      width: 320px;
      max-width: 36vw;
      background: #222;
      padding: 20px;
      color: white;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      min-width: 260px;
    }

    .ai-header {
      text-align: center;
      font-size: 1.6em;
      margin-bottom: 10px;
    }

    #log {
      flex: 1;
      background: #1d1d1d;
      padding: 10px;
      border-radius: 12px;
      font-size: 0.9em;
      overflow-y: auto;
      min-height: 0;
      scroll-behavior: smooth;
    }

    #quizOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 18px;
      box-sizing: border-box;
    }

    #quizContent {
      width: min(920px, 100%);
      max-height: calc(100vh - 36px);
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
      padding: 0;
    }

    #quizBox {
      background: #222;
      padding: 22px;
      border-radius: 20px;
      color: white;
      text-align: center;
      box-sizing: border-box;
    }

    #quizResults {
      color: white;
      text-align: left;
      background: #333;
      padding: 18px;
      border-radius: 12px;
      box-sizing: border-box;
    }

    .option-btn {
      padding: 15px;
      border: none;
      border-radius: 10px;
      background: #9b59b6;
      color: white;
      cursor: pointer;
      font-size: 1.05em;
      transition: 0.3s;
      width: 100%;
    }

    .option-btn:disabled {
      opacity: 0.75;
      cursor: not-allowed;
    }

    #replayBtn {
      margin-top: 14px;
      cursor: pointer;
      font-weight: bold;
      color: #9b59b6;
      text-align: center;
    }

    #replayBtn:hover {
      color: #fff;
    }

    @media (max-width: 860px){
      .app{
        flex-direction: column;
      }
      .ai-section{
        width: 100%;
        max-width: 100%;
        min-width: 0;
        height: 32vh;
      }
      .image-area{
        height: 68vh;
      }
      .icons{
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
      }
      .post-frame{
        width: 86%;
        max-width: 420px;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="image-area">
      <div id="postFrame" class="post-frame">
        <div id="postMedia"></div>
      </div>

      <div class="icons">
        <button class="icon-btn" data-action="like"><span class="material-icons">favorite</span></button>
        <button class="icon-btn" data-action="comment"><span class="material-icons">comment</span></button>
        <button class="icon-btn" data-action="skip"><span class="material-icons">cancel</span></button>
        <button class="icon-btn" data-action="share"><span class="material-icons">share</span></button>
      </div>
    </div>

    <div class="ai-section">
      <div class="ai-header">ü§ñ Was die KI sieht</div>
      <div id="log"></div>
    </div>
  </div>

  <div id="quizOverlay">
    <div id="quizContent">
      <div id="quizBox"></div>
      <div id="quizResults"></div>
    </div>
  </div>

  <script>
    (function(){
      // -----------------------------
      // 1) DATA
      // -----------------------------
      const categories = [
        "Humor",
        "Musik",
        "Tiere",
        "Sport",
        "Gaming",
        "Kochen",
        "Movie"
      ];

      const content = [
        { cat: "Humor", type: "iframe", src: "https://giphy.com/embed/8rN9VXNb7dfU792YQt", width: 270, height: 480 },
        { cat: "Humor", type: "iframe", src: "https://giphy.com/embed/JIX9t2j0ZTN9S", width: 270, height: 480 },
        { cat: "Humor", type: "iframe", src: "https://giphy.com/embed/l1rrKjeprm2VsbCc1w" },

        { cat: "Musik", type: "iframe", src: "https://giphy.com/embed/Ii4CrLzLooAjryNiNk", width: 270, height: 480 },
        { cat: "Musik", type: "iframe", src: "https://giphy.com/embed/TKutFlo2v9KN7zwUbY", width: 270, height: 480 },
        { cat: "Musik", type: "iframe", src: "https://giphy.com/embed/kxfQnpf3UGAaAUajXn", width: 270, height: 480 },

        { cat: "Sport", type: "iframe", src: "https://giphy.com/embed/8PEe5JNCsV6HPqeLpC", width: 270, height: 480 },
        { cat: "Sport", type: "iframe", src: "https://giphy.com/embed/316JKVkNXyl1YqBTWj", width: 270, height: 480 },
        { cat: "Sport", type: "img", src: "gym.jpg", width: 270, height: 480 },

        { cat: "Tiere", type: "iframe", src: "https://giphy.com/embed/Vi0Ws3t4JSLOgdkaBq", width: 270, height: 480 },
        { cat: "Tiere", type: "img", src: "cat.jpg", width: 270, height: 480 },
        { cat: "Tiere", type: "img", src: "dog.jpg", width: 270, height: 480 },

        { cat: "Gaming", type: "iframe", src: "https://giphy.com/embed/V5l5ZucxUc7kNTaXWK", width: 270, height: 480 },
        { cat: "Gaming", type: "iframe", src: "https://giphy.com/embed/ysiCYZUJkW3XRb7k9K", width: 270, height: 480 },
        { cat: "Gaming", type: "iframe", src: "https://giphy.com/embed/8UiYQWoZgafFJaN9hw", width: 270, height: 480 },

        { cat: "Kochen", type: "img", src: "cake.jpg", width: 270, height: 480 },
        { cat: "Kochen", type: "img", src: "cookies.jpg", width: 270, height: 480 },

        { cat: "Movie", type: "img", src: "movie.jpg", width: 270, height: 480 },
        { cat: "Movie", type: "img", src: "netflix.jpg", width: 270, height: 480 },
        { cat: "Movie", type: "img", src: "strangerthing.jpg", width: 270, height: 480 }
      ];

      // -----------------------------
      // 2) PERSONALIZATION MODEL
      // -----------------------------
      // We track:
      // - impressions per category (fairness if some cats have fewer items)
      // - action counts (like/comment/share/skip)
      // - dwell time per category (avg seconds)
      // - score per category (actions + dwell)
      //
      // Key improvements vs old version:
      // - skip has a NEGATIVE effect
      // - dwell time influences interest (even on skip)
      // - normalize by impressions so categories with fewer posts aren't punished
      const stats = {}; // cat -> {impressions, score, dwellSumMs, actions:{like,comment,share,skip}}

      // Scoring knobs (easy to tweak)
      const ACTION_POINTS = { like: 2, comment: 4, share: 6, skip: -2 };
      const DWELL_CLAMP_SEC = 8;               // cap dwell signal so "walk away" doesn't dominate
      const DWELL_POINTS_MAX = 2.5;            // up to +2.5 points per post from dwell
      const FAST_SKIP_SEC = 1.0;               // extra penalty if skipping too fast
      const FAST_SKIP_PENALTY = -1.0;

      // -----------------------------
      // 3) AD TEMPLATES (single + combo)
      // -----------------------------
      // Instead of one generic ad per category, we:
      // - have 2 variants per category depending on "strength"
      // - have a few combo ads for the top-2 (feels more adapted)
      //
      // The quiz will pick the best matching template based on top categories and strength.
      const AD_LIBRARY = {
        single: {
          Humor: {
            strong: "Comedy-Abo + Live-Show Tickets",
            weak:   "Kurze Comedy-Clips & Creator-Empfehlungen"
          },
          Musik: {
            strong: "Noise-Cancelling Kopfh√∂rer + Musik-Abo",
            weak:   "Playlist-Empfehlungen & Konzert-Tipps"
          },
          Tiere: {
            strong: "Premium-Futter + Spielzeug f√ºr Haustiere",
            weak:   "S√º√üe Tier-Accounts & Adoptions-Infos"
          },
          Sport: {
            strong: "Fitness-Deal: Smartwatch + Trainingsplan",
            weak:   "Sportshirt-Angebote & lokale Kurse"
          },
          Gaming: {
            strong: "Gaming-Setup Rabatt (GPU/Headset/Chair)",
            weak:   "Game-Releases & Indie-Deals"
          },
          Kochen: {
            strong: "Airfryer + K√ºchenbundle (Messer/Tools)",
            weak:   "Schnelle Rezepte & K√ºchen-Hacks"
          },
          Movie: {
            strong: "Streaming-Bundle + Kino-Gutscheine",
            weak:   "Film-/Serien-Empfehlungen (dein Geschmack)"
          }
        },
        combo: [
          { a: "Musik",  b: "Sport",  ad: "Sport-Kopfh√∂rer + Lauf-Playlist Bundle" },
          { a: "Movie",  b: "Humor",  ad: "Comedy-Serien Paket + Streaming-Probeabo" },
          { a: "Gaming", b: "Movie",  ad: "Game-Verfilmungen + Gamer-Streaming Bundle" },
          { a: "Tiere",  b: "Humor",  ad: "Funny-Pets Creator Bundle + Merch-Deals" },
          { a: "Kochen", b: "Movie",  ad: "Snack-Box Abo f√ºr Filmabende" },
          { a: "Gaming", b: "Musik",  ad: "Gaming-Headset + Music EQ Presets" }
        ]
      };

      // -----------------------------
      // 4) STATE / FEED LOGIC
      // -----------------------------
      let currentIndex = 0;
      let clicks = 0;
      let currentPost = null;
      let quizDisplayed = false;
      let finished = false;

      let shuffledContent = [];

      // Timing
      let postShownAt = 0;
      let perPostTimings = []; // each action record

      function shuffle(array){
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function init(){
        // init stats
        categories.forEach(cat => {
          stats[cat] = {
            impressions: 0,
            score: 0,
            dwellSumMs: 0,
            actions: { like: 0, comment: 0, share: 0, skip: 0 }
          };
        });

        clicks = 0;
        quizDisplayed = false;
        finished = false;

        perPostTimings = [];
        postShownAt = 0;

        shuffledContent = shuffle([...content]);
        currentIndex = 0;

        document.getElementById('log').innerHTML = '';
        document.getElementById('quizBox').innerHTML = '';
        document.getElementById('quizResults').innerHTML = '';
        document.getElementById('quizOverlay').style.display = 'none';

        showPost(currentIndex);
        toggleInteraction(true);
      }

      function setFrameMode(post){
        const frame = document.getElementById('postFrame');
        frame.classList.remove('portrait', 'landscape');
        const isLandscape = (post.width && post.height) ? (post.width > post.height) : false;
        frame.classList.add(isLandscape ? 'landscape' : 'portrait');
      }

      function markPostShownNow(){
        postShownAt = performance.now();
      }

      function showPost(index){
        currentPost = shuffledContent[index];
        setFrameMode(currentPost);

        // count impression immediately (the post is served)
        if (stats[currentPost.cat]) stats[currentPost.cat].impressions += 1;

        const mediaHost = document.getElementById('postMedia');
        mediaHost.innerHTML = '';

        let el;

        if(currentPost.type === "img"){
          el = document.createElement('img');
          el.src = currentPost.src;
          el.alt = currentPost.cat || "Post";

          el.onload = () => markPostShownNow();
          el.onerror = () => markPostShownNow();

          mediaHost.appendChild(el);
          requestAnimationFrame(() => { el.style.opacity = 1; });

          setTimeout(() => { if(!postShownAt) markPostShownNow(); }, 0);
          return;
        }

        if(currentPost.type === "iframe"){
          el = document.createElement('iframe');
          el.src = currentPost.src;
          el.allowFullscreen = true;

          el.onload = () => markPostShownNow();

          mediaHost.appendChild(el);
          requestAnimationFrame(() => { el.style.opacity = 1; });

          setTimeout(() => { if(!postShownAt) markPostShownNow(); }, 150);
          return;
        }
      }

      function appendLog(html){
        const log = document.getElementById('log');
        const wasAtBottom = (log.scrollHeight - log.scrollTop - log.clientHeight) < 12;
        log.insertAdjacentHTML('beforeend', html);
        if (wasAtBottom) log.scrollTop = log.scrollHeight;
      }

      function maybeEndOrNext(){
        if (currentIndex >= shuffledContent.length - 1){
          finished = true;
          if (!quizDisplayed){
            quizDisplayed = true;
            showQuiz();
          }
          return;
        }

        currentIndex += 1;
        postShownAt = 0;
        showPost(currentIndex);

        // optional early quiz
        if(clicks >= 20 && !quizDisplayed){
          quizDisplayed = true;
          showQuiz();
        }
      }

      document.querySelector('.image-area').addEventListener('click', e => {
        e.stopPropagation();
      });

      // -----------------------------
      // 5) SCORING
      // -----------------------------
      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

      function addSignalForAction(cat, action, timeSpentMs){
        const s = stats[cat];
        if(!s) return;

        // action points
        const base = ACTION_POINTS[action] ?? 0;

        // dwell points (0..DWELL_POINTS_MAX), using clamped seconds
        const dwellSec = clamp((timeSpentMs || 0) / 1000, 0, DWELL_CLAMP_SEC);
        const dwellPoints = (dwellSec / DWELL_CLAMP_SEC) * DWELL_POINTS_MAX;

        // fast-skip penalty (makes "instant skip" clearly negative)
        let fastSkipExtra = 0;
        if (action === "skip" && dwellSec <= FAST_SKIP_SEC) fastSkipExtra = FAST_SKIP_PENALTY;

        // total delta
        const delta = base + dwellPoints + fastSkipExtra;

        // update stats
        s.score += delta;
        s.dwellSumMs += (timeSpentMs || 0);
        s.actions[action] += 1;
      }

      function interestTable(){
        // Normalize by impressions so fewer posts doesn‚Äôt automatically lose.
        // Also include average dwell as a ‚Äúsecondary‚Äù signal for explanation.
        return categories.map(cat => {
          const s = stats[cat];
          const imp = Math.max(1, s.impressions);
          const scorePerImp = s.score / imp;
          const avgDwellSec = (s.dwellSumMs / imp) / 1000;
          return { cat, scorePerImp, avgDwellSec, impressions: s.impressions, rawScore: s.score, actions: s.actions };
        }).sort((a,b) => b.scorePerImp - a.scorePerImp);
      }

      function topN(n){
        return interestTable().slice(0, n);
      }

      // -----------------------------
      // 6) QUIZ: pick ad based on top-2 + strength
      // -----------------------------
      function pickPersonalizedAd(top){
        // top: array from interestTable sorted desc
        const t1 = top[0];
        const t2 = top[1];

        // strength heuristic: strong if scorePerImp is meaningfully above 0 and engagement not just dwell
        // (You can tune this; it‚Äôs simple but ‚Äúfeels‚Äù better than always same ad.)
        function isStrong(t){
          const a = t.actions;
          const engaged = (a.share + a.comment + a.like) - a.skip; // net engagement
          return (t.scorePerImp >= 1.8) || (engaged >= 2 && t.avgDwellSec >= 1.5);
        }

        // Try a combo ad if top2 is a known pair and both are at least "somewhat present"
        let combo = null;
        if (t1 && t2){
          combo = AD_LIBRARY.combo.find(x =>
            (x.a === t1.cat && x.b === t2.cat) || (x.a === t2.cat && x.b === t1.cat)
          );

          // only use combo if top2 isn't tiny/noisy
          const ok = (t1.scorePerImp > 0.3) && (t2.scorePerImp > 0.2);
          if (!ok) combo = null;
        }

        if (combo){
          return {
            ad: combo.ad,
            rule: "combo",
            why: `Deine Top-2 Interessen sind <strong>${t1.cat}</strong> und <strong>${t2.cat}</strong> ‚Äì deshalb eine Kombi-Werbung.`
          };
        }

        // Otherwise choose strong/weak single ad for top1
        const strength = isStrong(t1) ? "strong" : "weak";
        const ad = (AD_LIBRARY.single[t1.cat] && AD_LIBRARY.single[t1.cat][strength]) || "Personalisierte Werbung";
        return {
          ad,
          rule: `single-${strength}`,
          why: `Dein st√§rkstes Interesse ist <strong>${t1.cat}</strong> ‚Äì und die KI w√§hlt eine ${strength === "strong" ? "st√§rkere" : "leichtere"} Werbevariante.`
        };
      }

      function buildQuizOptions(correctAd){
        // Build a pool of plausible ads (all singles + combos), then pick 2 distractors
        const pool = [];

        // singles
        for (const cat of categories){
          const obj = AD_LIBRARY.single[cat];
          if (obj?.strong) pool.push(obj.strong);
          if (obj?.weak)   pool.push(obj.weak);
        }
        // combos
        AD_LIBRARY.combo.forEach(x => pool.push(x.ad));

        // unique + not correct
        const uniq = [...new Set(pool)].filter(x => x !== correctAd);

        // pick 2 distractors, shuffle
        shuffle(uniq);
        const distractors = uniq.slice(0, 2);

        const options = shuffle([correctAd, ...distractors]).slice(0, 3);
        return options;
      }

      // -----------------------------
      // 7) UI HANDLERS
      // -----------------------------
      document.querySelector('.icons').addEventListener('click', e => {
        const btn = e.target.closest('.icon-btn');
        if(!btn) return;

        const action = btn.dataset.action;

        const now = performance.now();
        const timeSpentMs = postShownAt ? (now - postShownAt) : 0;
        const timeSpentSec = (timeSpentMs / 1000).toFixed(2);

        // update model
        addSignalForAction(currentPost.cat, action, timeSpentMs);

        // store detail record
        perPostTimings.push({
          index: currentIndex,
          cat: currentPost.cat,
          action,
          timeSpentMs,
          src: currentPost.src,
          type: currentPost.type
        });

        const interpretations = {
          like: "Interesse-Signal: positiv (Like) + Verweildauer.",
          comment: "Interesse-Signal: sehr positiv (Kommentar) + Verweildauer.",
          share: "Interesse-Signal: extrem positiv (Share) + Verweildauer.",
          skip: "Interesse-Signal: negativ (Skip), aber Verweildauer z√§hlt trotzdem etwas."
        };

        const icons = { like: "‚ù§Ô∏è", comment: "üí¨", share: "üîó", skip: "‚è≠Ô∏è" };

        appendLog(`
          <div>
            ${icons[action]} <strong>${currentPost.cat}</strong> wurde
            ${action==="like" ? "geliked" : action==="comment" ? "kommentiert" : action==="share" ? "geteilt" : "√ºbersprungen"}
            <br><em>‚è±Ô∏è Zeit bis Klick: ${timeSpentSec}s</em>
            <br>‚Üí ${interpretations[action]}
          </div><br>
        `);

        clicks++;
        maybeEndOrNext();
      });

      function avgTimeByCategory(){
        const map = {};
        perPostTimings.forEach(t => {
          if(!map[t.cat]) map[t.cat] = { sum: 0, count: 0 };
          map[t.cat].sum += t.timeSpentMs || 0;
          map[t.cat].count += 1;
        });
        return Object.entries(map).map(([cat, v]) => ({
          cat,
          avgSec: v.count ? (v.sum / v.count / 1000) : 0,
          count: v.count
        })).sort((a,b)=> b.avgSec - a.avgSec);
      }

      function showQuiz(){
        toggleInteraction(false);

        const overlay = document.getElementById('quizOverlay');
        const box = document.getElementById('quizBox');
        const resultsEl = document.getElementById('quizResults');
        overlay.style.display = "flex";

        const table = interestTable();
        const top3 = table.slice(0,3);

        // pick the ad using improved rules
        const pick = pickPersonalizedAd(table);
        const correctAd = pick.ad;

        // options (correct + distractors)
        const options = buildQuizOptions(correctAd);

        box.innerHTML = `
          <div style="font-size:1.1em;margin-bottom:12px;">
            üí° Welche Werbung wird dir die KI als N√§chstes zeigen?
          </div>

          <div style="display:flex;flex-direction:column;gap:12px;">
            ${options.map(opt => `<button class="option-btn" data-answer="${opt}">${opt}</button>`).join('')}
          </div>

          <div style="margin-top:12px;font-size:0.9em;opacity:0.85;">
            (Hinweis: Die KI nutzt jetzt auch <em>Verweildauer</em> und <em>negatives Skip-Signal</em>.)
          </div>
        `;

        resultsEl.innerHTML = '';

        document.querySelectorAll('.option-btn').forEach(btn => {
          btn.onclick = () => {
            document.querySelectorAll('.option-btn').forEach(b => {
              b.disabled = true;
              if(b.dataset.answer === correctAd){
                b.style.background = "#4CAF50";
              } else if(b === btn){
                b.style.background = "#F44336";
              }
            });

            const avgByCat = avgTimeByCategory();
            const timingHtml = avgByCat.length
              ? `
                <div style="margin:12px 0; padding:12px; background:#222; border-radius:10px;">
                  <strong>‚è±Ô∏è Durchschnittliche Zeit bis Aktion (pro Kategorie):</strong><br>
                  ${avgByCat.map(x => `${x.cat}: ${x.avgSec.toFixed(2)}s (n=${x.count})`).join('<br>')}
                </div>
              `
              : `
                <div style="margin:12px 0; padding:12px; background:#222; border-radius:10px;">
                  <strong>‚è±Ô∏è Zeitdaten:</strong><br>
                  Noch keine Daten gesammelt.
                </div>
              `;

            const topExplain = top3.map((t,i) => {
              const a = t.actions;
              const line1 = `${i+1}) <strong>${t.cat}</strong> ‚Äî Score/Impression: <strong>${t.scorePerImp.toFixed(2)}</strong>, Avg Dwell: <strong>${t.avgDwellSec.toFixed(2)}s</strong>, Impressions: ${t.impressions}`;
              const line2 = `&nbsp;&nbsp;Likes ${a.like} ¬∑ Comments ${a.comment} ¬∑ Shares ${a.share} ¬∑ Skips ${a.skip}`;
              return `${line1}<br>${line2}`;
            }).join("<br><br>");

            // show results with explicit "why this ad"
            resultsEl.innerHTML = `
              <p style="margin-top:0;">
                Hier ist, was die KI aus deinem Verhalten ableitet ‚Äì inklusive <strong>Verweildauer</strong>,
                <strong>negativem Skip</strong> und einer <strong>Kombi-Werbung</strong>, wenn Top-2 gut passt.
              </p>

              <div style="margin:12px 0; padding:12px; background:#222; border-radius:10px;">
                <strong>Warum genau diese Werbung?</strong><br>
                ${pick.why}<br>
                <em>Regel:</em> ${pick.rule}
              </div>

              <div style="margin:12px 0; padding:12px; background:#222; border-radius:10px;">
                <strong>Top-3 Interessen (normalisiert):</strong><br><br>
                ${topExplain}
              </div>

              ${timingHtml}

              <div style="margin-top:10px;">
                <strong>Details (alle Kategorien):</strong><br>
                ${table.map(t => {
                  const a = t.actions;
                  return `
                    <strong>${t.cat}</strong>:
                    Score/Imp ${t.scorePerImp.toFixed(2)},
                    Dwell ${t.avgDwellSec.toFixed(2)}s,
                    Imp ${t.impressions},
                    L${a.like}/C${a.comment}/S${a.share}/K${a.skip}
                  `;
                }).join('<br>')}
              </div>

              <div id="replayBtn">üîÑ NOCHMAL SPIELEN</div>
            `;

            resultsEl.scrollIntoView({ behavior: "smooth", block: "start" });

            document.getElementById('replayBtn').onclick = () => {
              overlay.style.display = 'none';
              init();
            };
          };
        });
      }

      function toggleInteraction(enable){
        document.querySelectorAll('.icon-btn').forEach(b => b.disabled = !enable);
      }

      init();
    })();
  </script>
</body>
</html>
